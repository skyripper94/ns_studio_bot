# Copilot / AI agent instructions for ns_studio_bot

Краткое описание
- Небольшой сервис на Flask (`app.py`) который принимает JSON POST в `/process` с base64-изображением и возвращает обработанное изображение (JPEG).
- Сервис предназначен для генерации обложек: улучшение фото, затемнение снизу градиентом, отрисовка логотипа `NEUROSTEP`, центрированный заголовок (стретч + тень), стрелка справа.

Ключевые файлы
- `app.py` — вся логика приложения: маршруты `/process` и `/health`, обработка изображения через Pillow.
- `Procfile` — запуск в проде: `web: gunicorn app:app`.
- `requirements.txt` — зависимости: `Flask`, `Pillow`, `gunicorn`.
- `nixpacks.toml` — при билде добавляются системные шрифты (`fonts-dejavu-core`, `fonts-liberation`, `fontconfig`).
- `fonts/` — папка для локальных шрифтов (fallbacks используются из неё при наличии).

API и формат данных (конкретный пример)
- Endpoint: `POST /process`
- Request JSON:
  ```json
  {
    "image": "<base64-jpeg-or-png>",
    "text": "Текст заголовка",
    "config": { "gradientPercent": 40, "fontSize": 42 }
  }
  ```
- Response: `image/jpeg` (binary). В случае ошибки возвращается JSON `{ "error": "..." }` с кодом 500.

Важно для агентов (практические замечания)
- Порядок обработки изображений в `app.py` (важно при правках):
  1. Декодирование base64 -> PIL.Image
 2. Улучшения: `Sharpness.enhance(3.7)`, `Contrast.enhance(1.2)`, `Brightness.enhance(0.95)`.
 3. Наложение нижнего черного градиента (нижние ~35% полностью черные, затем плавный градиент выше).
 4. Рисование логотипа `NEUROSTEP` (шрифт через `get_font(20)`).
 5. Основной текст: приводится к `upper()`, разбивается на строки по ширине `max_width = int(width * 0.88)` с измерением через `draw.textbbox`.
 6. Для каждой линии текст рендерится во временном `RGBA` изображении, затем вертикально растягивается (`resize` до ~115% высоты) и вставляется в итог.
 7. Рисуется стрелка справа; сохраняется как JPEG.

- `get_font(size, bold=True)` ищет шрифты в следующем порядке: system Liberation Sans (в `/usr/share/fonts/...`), `fonts/` в проекте, DejaVu Sans. Агентам: не удаляйте эту логику — она обеспечивает portable fallback.
- В `/health` возвращается `version: NEUROSTEP_v3_CYAN_GLOW` и `features` — используйте это как подсказку при релизах, но сверяйтесь с кодом: реальный «CYAN glow» визуально не реализован явным слоем (в коде используются белый текст и тень). Документируйте любые визуальные изменения в `version`.
- Логирование — через `print()`. Для отладки в dev можно смотреть stdout; в проде Gunicorn соберет логи.

Запуск и отладка
- Локально (быстро):
  ```bash
  python -m venv .venv
  source .venv/bin/activate
  pip install -r requirements.txt
  python app.py   # слушает 0.0.0.0:5000
  ```
- В контейнер/деплой используйте `Procfile` (Heroku-style): `gunicorn app:app`.
- Проверка здоровья: `GET /health` (порт 5000 в dev).
- Тест CURL (пример):
  ```bash
  curl -s -X POST http://localhost:5000/process \
    -H 'Content-Type: application/json' \
    -d '{"image":"<base64>","text":"Пример","config":{"gradientPercent":40,"fontSize":42}}' --output out.jpg
  ```

Практические указания для изменения кода
- Избегайте изменения публичного API (`/process`, `/health`) без координации.
- Любые добавленные пакеты — фиксируйте в `requirements.txt` и в `nixpacks.toml`, если требуются системные шрифты или утилиты.
- Если меняете рендер-технику (напр. добавляете настоящий CYAN glow), уменьшите резкость/контрастную настройку тестов и обновите `version` в `/health`.
- При правках, влияющих на производительность (например, большие шрифты, большие временные изображения), профилируйте память — рендер делается в памяти и может потребовать ограничения размера входного изображения.

Паттерны и конвенции
- Измерение текста: всегда используйте `draw.textbbox` для корректного расчёта ширины/высоты.
- Максимальная ширина заголовка — `int(width * 0.88)`; межстрочный шаг: `int(font_size * 1.02)`.
- Стретчинг текста реализован через создание временного изображения и `resize` с `Image.Resampling.LANCZOS` — сохраняйте этот подход при рефакторинге.

Если что-то неясно
- Скажите, какую часть хотите изменить (визуал, API или деплой) — добавлю примеры патчей и тест-кейсы.

---
Автор: сгенерировано автоматически — пожалуйста, оставьте комментарии если нужны правки.
